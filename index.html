#!/usr/bin/env python3
# bot.py

import os
import logging
import requests
from bs4 import BeautifulSoup
from telegram import Update, ParseMode
from telegram.ext import (
    Updater,
    CommandHandler,
    CallbackContext,
)

# --- Configura√ß√£o de logs ---
logging.basicConfig(
    format="%(asctime)s - %(name)s - %(levelname)s - %(message)s",
    level=logging.INFO
)
logger = logging.getLogger(__name__)


# --- Fun√ß√£o de callback para deletar mensagem ---
def delete_message(context: CallbackContext):
    job = context.job
    chat_id = job.context["chat_id"]
    message_id = job.context["message_id"]
    try:
        context.bot.delete_message(chat_id=chat_id, message_id=message_id)
    except Exception as e:
        logger.warning(f"N√£o foi poss√≠vel deletar mensagem {message_id}: {e}")


# --- /teste handler ---
def cmd_teste(update: Update, ctx: CallbackContext):
    if not ctx.args:
        return update.message.reply_text("‚ùó Uso: /teste <token>")

    token = ctx.args[0]
    url = f"https://vsplus.atxhost.com.br/criarteste.php?token={token}"
    try:
        resp = requests.get(url, timeout=10)
        resp.raise_for_status()
    except Exception:
        return update.message.reply_text(
            "‚ùó N√£o consegui buscar o teste. Tente novamente mais tarde."
        )

    soup = BeautifulSoup(resp.text, "html.parser")
    text = soup.get_text("\n")
    data = {}
    # Extrai linhas de interesse
    for line in text.splitlines():
        line = line.strip()
        for key in ("Usuario", "Senha", "Validade", "Limite", "Loja de Apps", "Link de Renova√ß√£o"):
            if line.startswith(key):
                data[key] = line.split(":", 1)[1].strip()

    if not data:
        return update.message.reply_text(
            "‚ö†Ô∏è N√£o encontrei informa√ß√µes para esse token."
        )

    # Monta mensagem Markdown
    lines = ["üéâ *Teste Criado!*"]
    for key in ("Usuario","Senha","Validade","Limite","Loja de Apps","Link de Renova√ß√£o"):
        if key in data:
            val = data[key]
            if key in ("Loja de Apps","Link de Renova√ß√£o") and val.startswith("http"):
                val = f"[Link]({val})"
            lines.append(f"*{key}:* {val}")
    msg_text = "\n".join(lines)

    sent = update.message.reply_text(
        msg_text,
        parse_mode=ParseMode.MARKDOWN,
        disable_web_page_preview=True
    )

    # Agenda exclus√£o ap√≥s 4 horas (14400 segundos)
    ctx.job_queue.run_once(
        delete_message,
        when=14400,
        context={"chat_id": sent.chat_id, "message_id": sent.message_id}
    )


# --- /start handler ---
def cmd_start(update: Update, ctx: CallbackContext):
    update.message.reply_text(
        "üëã Ol√°! Use `/teste <token>` para criar um teste e receber suas credenciais.",
        parse_mode=ParseMode.MARKDOWN
    )


def main():
    token = os.environ.get("BOT_TOKEN")
    if not token:
        logger.error("‚ö†Ô∏è Defina a vari√°vel de ambiente BOT_TOKEN com o token do seu bot.")
        return

    updater = Updater(token)
    dp = updater.dispatcher

    dp.add_handler(CommandHandler("start", cmd_start))
    dp.add_handler(CommandHandler("teste", cmd_teste))

    updater.start_polling()
    logger.info("Bot iniciado. Aguardando comandos‚Ä¶")
    updater.idle()


if __name__ == "__main__":
    main()
